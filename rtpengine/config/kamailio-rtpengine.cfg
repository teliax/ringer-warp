# Kamailio RTPEngine Integration Configuration
# Add this to your Kamailio configuration

#!define WITH_RTPENGINE

# RTPEngine control socket
modparam("rtpengine", "rtpengine_sock", "udp:127.0.0.1:22222")

# For multiple RTPEngine instances (load balancing)
modparam("rtpengine", "rtpengine_sock", "1 == udp:34.123.38.31:22222")
modparam("rtpengine", "rtpengine_sock", "2 == udp:35.222.101.214:22222")
modparam("rtpengine", "rtpengine_sock", "3 == udp:35.225.65.80:22222")

# RTPEngine timeouts
modparam("rtpengine", "rtpengine_tout_ms", 1000)
modparam("rtpengine", "rtpengine_retr", 5)
modparam("rtpengine", "extra_id_pv", "$avp(extra_id)")
modparam("rtpengine", "setid_avp", "$avp(setid)")

# Enable RTP statistics
modparam("rtpengine", "rtp_inst_pvar", "$avp(RTP_INSTANCE)")

# Route block for RTPEngine
route[RTPENGINE] {
    if (!has_body("application/sdp")) {
        return;
    }

    # Set RTPEngine instance based on load balancing
    # You can implement various strategies here
    $avp(setid) = 1; # Default to instance 1
    
    # Simple round-robin load balancing example
    if ($ci =~ "1$|4$|7$") {
        $avp(setid) = 1;
    } else if ($ci =~ "2$|5$|8$") {
        $avp(setid) = 2;
    } else {
        $avp(setid) = 3;
    }

    # For INVITE requests
    if (is_method("INVITE")) {
        # Handle NAT traversal
        if (nat_uac_test("19")) {
            # NAT detected
            rtpengine_manage("replace-origin replace-session-connection ICE=force RTP/AVP");
        } else {
            rtpengine_manage("replace-origin replace-session-connection ICE=remove RTP/AVP");
        }
    }
    
    # For answers (200 OK)
    if (is_method("ACK") && has_body("application/sdp")) {
        rtpengine_manage("replace-origin replace-session-connection");
    }
    
    # For re-INVITE
    if (is_method("INVITE") && has_totag()) {
        rtpengine_manage("replace-origin replace-session-connection");
    }
}

# Route block for WebRTC handling
route[WEBRTC] {
    if (!has_body("application/sdp")) {
        return;
    }

    # WebRTC to SIP
    if ($ru =~ "transport=ws") {
        rtpengine_manage("direction=external direction=internal ICE=remove RTP/AVP");
    }
    # SIP to WebRTC
    else if ($du =~ "transport=ws") {
        rtpengine_manage("direction=internal direction=external ICE=force UDP/TLS/RTP/SAVPF");
    }
}

# Main request routing
request_route {
    # ... other routes ...

    # Handle RTPEngine for INVITE
    if (is_method("INVITE")) {
        route(RTPENGINE);
    }

    # ... other routes ...
}

# Reply routing
onreply_route[MANAGE_REPLY] {
    # Handle RTPEngine for replies with SDP
    if (has_body("application/sdp")) {
        route(RTPENGINE);
    }
}

# Failure routing
failure_route[MANAGE_FAILURE] {
    # Clean up RTPEngine session on failure
    if (t_is_canceled()) {
        rtpengine_delete();
        exit;
    }

    # ... other failure handling ...
}

# Dialog end - cleanup RTPEngine
event_route[dialog:end] {
    rtpengine_delete();
}

# BYE request - cleanup RTPEngine
route[BYE] {
    if (is_method("BYE")) {
        rtpengine_delete();
    }
}