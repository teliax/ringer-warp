# VM Specifications for RTPEngine Instances
# Project: ringer-warp-v01
# Region: us-central1

project:
  id: ringer-warp-v01
  region: us-central1
  zone: us-central1-a

# Golden VM configuration (used as template)
golden_vm:
  name: warp-rtpengine-golden
  machine_type: e2-standard-4
  description: "Golden image VM for RTPEngine deployment"
  
  # Hardware specs
  specs:
    vcpus: 4
    memory_gb: 16
    
  # Boot disk configuration
  boot_disk:
    size_gb: 50
    type: pd-standard
    image_family: debian-11
    image_project: debian-cloud
    
  # Network configuration
  network:
    vpc: default
    subnet: default
    external_ip: ephemeral
    network_tier: PREMIUM
    
  # Firewall tags
  tags:
    - rtpengine
    - allow-ssh
    - allow-rtpengine-ports
    
  # Service account
  service_account:
    email: default
    scopes:
      - https://www.googleapis.com/auth/cloud-platform
      
  # Metadata
  metadata:
    enable-oslogin: "TRUE"
    startup-script: |
      #!/bin/bash
      # Update system
      apt-get update
      apt-get upgrade -y
      
      # Install basic tools
      apt-get install -y \
        curl \
        wget \
        git \
        vim \
        htop \
        net-tools \
        tcpdump \
        iptables-persistent
        
# Production VM configurations
production_vms:
  - name: warp-rtpengine-1
    zone: us-central1-a
    internal_ip: 10.128.0.20
    labels:
      environment: production
      service: rtpengine
      instance: "1"
      
  - name: warp-rtpengine-2
    zone: us-central1-b
    internal_ip: 10.128.0.21
    labels:
      environment: production
      service: rtpengine
      instance: "2"
      
  - name: warp-rtpengine-3
    zone: us-central1-c
    internal_ip: 10.128.0.22
    labels:
      environment: production
      service: rtpengine
      instance: "3"

# Firewall rules needed
firewall_rules:
  - name: allow-rtpengine-rtp
    description: "Allow RTP traffic for RTPEngine"
    direction: INGRESS
    priority: 1000
    source_ranges:
      - 0.0.0.0/0
    allowed:
      - protocol: udp
        ports: 
          - 10000-20000
    target_tags:
      - rtpengine
      
  - name: allow-rtpengine-control
    description: "Allow control port for RTPEngine"
    direction: INGRESS
    priority: 1000
    source_ranges:
      - 10.128.0.0/20  # Internal VPC range
    allowed:
      - protocol: tcp
        ports:
          - 22222  # Control port
          - 2223   # CLI port
    target_tags:
      - rtpengine
      
  - name: allow-rtpengine-websocket
    description: "Allow WebSocket for WebRTC"
    direction: INGRESS
    priority: 1000
    source_ranges:
      - 0.0.0.0/0
    allowed:
      - protocol: tcp
        ports:
          - 8080  # WebSocket port
    target_tags:
      - rtpengine

# Health check configuration
health_check:
  name: rtpengine-health-check
  type: TCP
  port: 22222
  check_interval_sec: 10
  timeout_sec: 5
  healthy_threshold: 2
  unhealthy_threshold: 3

# Load balancer configuration (optional)
load_balancer:
  name: rtpengine-lb
  type: INTERNAL
  scheme: INTERNAL_MANAGED
  port: 22222
  protocol: TCP
  session_affinity: CLIENT_IP
  backend_service:
    timeout_sec: 30
    connection_draining_timeout_sec: 60