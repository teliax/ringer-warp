apiVersion: v1
kind: ConfigMap
metadata:
  name: jasmin-consul-config
  namespace: messaging
data:
  service.json: |
    {
      "service": {
        "name": "jasmin",
        "tags": ["sms", "gateway", "warp"],
        "port": 8080,
        "meta": {
          "version": "0.10",
          "protocol": "http"
        },
        "check": {
          "id": "jasmin-health",
          "name": "Jasmin Health Check",
          "http": "http://localhost:8080/ping",
          "interval": "10s",
          "timeout": "5s"
        },
        "weights": {
          "passing": 10,
          "warning": 1
        }
      }
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: jasmin-consul-register
  namespace: messaging
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: consul-register
        image: consul:1.17
        command:
        - sh
        - -c
        - |
          # Wait for Jasmin to be ready
          until curl -s http://jasmin-api:8080/ping; do
            echo "Waiting for Jasmin..."
            sleep 5
          done
          
          # Register service with Consul
          consul services register /consul/service.json
        volumeMounts:
        - name: consul-config
          mountPath: /consul
        env:
        - name: CONSUL_HTTP_ADDR
          value: "consul-server.telecom.svc.cluster.local:8500"
      volumes:
      - name: consul-config
        configMap:
          name: jasmin-consul-config