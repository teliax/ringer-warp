# Kamailio RTPEngine Configuration Update
# Add this to your Kamailio configuration

#!ifdef WITH_RTPENGINE

# RTPEngine Control Protocol Parameters
modparam("rtpengine", "rtpengine_sock", "udp:10.0.1.2:2223")  # warp-rtpengine-1 Internal IP
modparam("rtpengine", "rtpengine_sock", "udp:10.0.1.3:2223")  # warp-rtpengine-2 Internal IP
modparam("rtpengine", "rtpengine_sock", "udp:10.0.1.4:2223")  # warp-rtpengine-3 Internal IP

# RTPEngine module parameters
modparam("rtpengine", "rtpengine_disable_tout", 20)
modparam("rtpengine", "rtpengine_tout_ms", 1000)
modparam("rtpengine", "rtpengine_retr", 5)
modparam("rtpengine", "extra_id_pv", "$avp(extra_id)")
modparam("rtpengine", "setid_avp", "$avp(setid)")

# Set RTPEngine instance selection algorithm
modparam("rtpengine", "setid_default", 1)
modparam("rtpengine", "hash_table_size", 256)
modparam("rtpengine", "hash_table_tout", 86400)

# Enable RTPEngine statistics
modparam("rtpengine", "check_blacklist_interval", 60)

#!endif

# RTPEngine Usage in Route Logic
route[NATMANAGE] {
#!ifdef WITH_RTPENGINE
    if (is_method("INVITE")) {
        # Check if this is a WebRTC call
        if ($hdr(User-Agent) =~ "WebRTC" || 
            search_body("m=application.*webrtc") ||
            search_body("a=fingerprint:") ||
            search_body("a=setup:")) {
            
            # WebRTC to SIP
            if ($ru =~ "transport=ws") {
                rtpengine_offer("trust-address replace-origin replace-session-connection " +
                               "ICE=remove RTP/AVP rtcp-mux-demux");
            } else {
                # SIP to WebRTC
                rtpengine_offer("trust-address replace-origin replace-session-connection " +
                               "ICE=force RTP/SAVPF rtcp-mux-require");
            }
        } else {
            # Regular SIP call
            rtpengine_offer("trust-address replace-origin replace-session-connection");
        }
    }
    
    if (is_method("ACK") && has_body("application/sdp")) {
        rtpengine_answer("trust-address replace-origin replace-session-connection");
    }
#!endif
    return;
}

route[RTPENGINE] {
#!ifdef WITH_RTPENGINE
    if (!has_totag()) {
        # Initial INVITE
        if (is_method("INVITE")) {
            # Set RTPEngine flags based on transport
            $avp(rtpengine_flags) = "trust-address replace-origin replace-session-connection";
            
            # Check for NAT
            if (nat_uac_test("3")) {
                $avp(rtpengine_flags) = $avp(rtpengine_flags) + " SIP-source-address";
            }
            
            # Handle transcoding if needed
            if ($rU =~ "^1900") {
                # Example: Force transcoding for specific number range
                $avp(rtpengine_flags) = $avp(rtpengine_flags) + " transcode=opus transcode=PCMU";
            }
            
            rtpengine_offer("$avp(rtpengine_flags)");
        }
    } else {
        # In-dialog requests
        if (is_method("INVITE|UPDATE")) {
            if (has_body("application/sdp")) {
                rtpengine_answer("trust-address replace-origin replace-session-connection");
            }
        }
    }
#!endif
    return;
}

# Handle replies
onreply_route[MANAGE_REPLY] {
    xlog("L_DBG", "Incoming reply: $rs $rr\n");
    
#!ifdef WITH_RTPENGINE
    if (has_body("application/sdp")) {
        if ($rs =~ "18[03]") {
            # Session progress or ringing with SDP
            rtpengine_answer("trust-address replace-origin replace-session-connection");
        } else if ($rs =~ "2[0-9][0-9]" && is_method("INVITE")) {
            # 2xx response to INVITE
            rtpengine_answer("trust-address replace-origin replace-session-connection");
        }
    }
#!endif
}

# Failure route - cleanup RTPEngine session
failure_route[MANAGE_FAILURE] {
#!ifdef WITH_RTPENGINE
    if (is_method("INVITE") && (t_is_canceled() || t_check_status("6[0-9][0-9]|5[0-9][0-9]|4[0-9][0-9]"))) {
        rtpengine_delete();
    }
#!endif
}

# Dialog end - cleanup RTPEngine session
route[DIALOG_END] {
#!ifdef WITH_RTPENGINE
    if (is_method("BYE|CANCEL")) {
        rtpengine_delete();
    }
#!endif
}