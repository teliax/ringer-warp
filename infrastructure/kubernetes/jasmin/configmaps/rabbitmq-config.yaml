apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: messaging
data:
  rabbitmq.conf: |
    # RabbitMQ Configuration for Jasmin SMSC

    ## Networking
    listeners.tcp.default = 5672

    ## Management Plugin
    management.tcp.port = 15672
    management.load_definitions = /etc/rabbitmq/definitions.json

    ## Logging - Debug mode for troubleshooting
    log.console.level = info
    log.connection.level = debug
    log.channel.level = debug
    log.queue.level = info
    log.mirroring.level = info
    log.federation.level = info
    log.upgrade.level = info
    
    ## Memory and Disk Limits
    vm_memory_high_watermark.relative = 0.6
    vm_memory_high_watermark_paging_ratio = 0.75
    disk_free_limit.absolute = 2GB
    
    ## Clustering
    cluster_partition_handling = autoheal
    
    ## Performance Tuning
    channel_max = 128
    frame_max = 131072
    heartbeat = 60
    
    ## Message TTL and Limits
    consumer_timeout = 1800000
    
    ## Statistics
    collect_statistics = fine
    collect_statistics_interval = 5000
    
    ## Background GC
    background_gc_enabled = true
    background_gc_target_interval = 60000
    
  enabled_plugins: |
    [rabbitmq_management,rabbitmq_prometheus,rabbitmq_shovel,rabbitmq_shovel_management].
    
  definitions.json: |
    {
      "users": [
        {
          "name": "jasmin",
          "password": "jasminpass123",
          "tags": "administrator"
        },
        {
          "name": "monitoring",
          "password": "monitorpass123",
          "tags": "monitoring"
        }
      ],
      "vhosts": [
        {
          "name": "/"
        },
        {
          "name": "jasmin"
        }
      ],
      "permissions": [
        {
          "user": "jasmin",
          "vhost": "/",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        },
        {
          "user": "jasmin",
          "vhost": "jasmin",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        },
        {
          "user": "monitoring",
          "vhost": "/",
          "configure": "",
          "write": "",
          "read": ".*"
        }
      ],
      "queues": [
        {
          "name": "submit.sm.req",
          "vhost": "jasmin",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-message-ttl": 3600000,
            "x-max-length": 100000,
            "x-queue-type": "classic"
          }
        },
        {
          "name": "submit.sm.resp",
          "vhost": "jasmin",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-message-ttl": 3600000,
            "x-max-length": 100000
          }
        },
        {
          "name": "dlr.queue",
          "vhost": "jasmin",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-message-ttl": 86400000,
            "x-max-length": 500000
          }
        },
        {
          "name": "billing.queue",
          "vhost": "jasmin",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-message-ttl": 604800000,
            "x-max-length": 1000000
          }
        }
      ],
      "exchanges": [
        {
          "name": "jasmin.submit.sm",
          "vhost": "jasmin",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "jasmin.dlr",
          "vhost": "jasmin",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "jasmin.billing",
          "vhost": "jasmin",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        }
      ],
      "bindings": [
        {
          "source": "jasmin.submit.sm",
          "vhost": "jasmin",
          "destination": "submit.sm.req",
          "destination_type": "queue",
          "routing_key": "submit.sm.#"
        },
        {
          "source": "jasmin.dlr",
          "vhost": "jasmin",
          "destination": "dlr.queue",
          "destination_type": "queue",
          "routing_key": "dlr.#"
        },
        {
          "source": "jasmin.billing",
          "vhost": "jasmin",
          "destination": "billing.queue",
          "destination_type": "queue",
          "routing_key": "billing.#"
        }
      ],
      "policies": [
        {
          "vhost": "jasmin",
          "name": "ha-jasmin",
          "pattern": ".*",
          "apply-to": "queues",
          "definition": {
            "ha-mode": "exactly",
            "ha-params": 2,
            "ha-sync-mode": "automatic"
          },
          "priority": 1
        }
      ]
    }