apiVersion: v1
kind: ConfigMap
metadata:
  name: kamailio-consul-config
  namespace: telecom
data:
  service.json: |
    {
      "service": {
        "name": "kamailio",
        "tags": ["sip", "proxy", "warp"],
        "port": 5060,
        "meta": {
          "version": "5.7",
          "protocol": "sip"
        },
        "check": {
          "id": "kamailio-health",
          "name": "Kamailio Health Check",
          "tcp": "localhost:5060",
          "interval": "10s",
          "timeout": "5s"
        },
        "weights": {
          "passing": 10,
          "warning": 1
        }
      }
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: kamailio-consul-register
  namespace: telecom
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: consul-register
        image: consul:1.17
        command:
        - sh
        - -c
        - |
          # Wait for Kamailio to be ready
          until nc -z kamailio-sip 5060; do
            echo "Waiting for Kamailio..."
            sleep 5
          done
          
          # Register service with Consul
          consul services register /consul/service.json
        volumeMounts:
        - name: consul-config
          mountPath: /consul
        env:
        - name: CONSUL_HTTP_ADDR
          value: "consul-server:8500"
      volumes:
      - name: consul-config
        configMap:
          name: kamailio-consul-config