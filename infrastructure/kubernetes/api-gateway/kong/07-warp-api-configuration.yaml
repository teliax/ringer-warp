# Kong Service for WARP API
apiVersion: configuration.konghq.com/v1
kind: KongIngress
metadata:
  name: warp-api-kongingress
  namespace: kong
proxy:
  protocol: http
  path: /
  connect_timeout: 60000
  write_timeout: 60000
  read_timeout: 60000
  retries: 3
route:
  strip_path: false
  preserve_host: true
  regex_priority: 0
  protocols:
  - http
  - https
  methods:
  - GET
  - POST
  - PUT
  - PATCH
  - DELETE
  - OPTIONS
  - HEAD
---
# WARP API Service in Kong
apiVersion: v1
kind: Service
metadata:
  name: warp-api-kong
  namespace: kong
  annotations:
    konghq.com/plugins: |
      global-rate-limit,
      cors,
      prometheus,
      request-size-limit
spec:
  type: ExternalName
  externalName: warp-api.warp-api.svc.cluster.local
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
---
# Authentication endpoints (no auth required)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: warp-api-auth
  namespace: kong
  annotations:
    kubernetes.io/ingress.class: kong
    konghq.com/plugins: |
      cors,
      global-rate-limit,
      prometheus,
      request-validator
    konghq.com/override: warp-api-kongingress
spec:
  rules:
  - host: api.ringer.tel
    http:
      paths:
      - path: /v1/auth/login
        pathType: Exact
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/auth/refresh
        pathType: Exact
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/health
        pathType: Exact
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
---
# Protected API endpoints (requires authentication)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: warp-api-protected
  namespace: kong
  annotations:
    kubernetes.io/ingress.class: kong
    konghq.com/plugins: |
      jwt-auth,
      api-key-auth,
      cors,
      global-rate-limit,
      prometheus,
      request-validator,
      response-transformer,
      acl
    konghq.com/override: warp-api-kongingress
spec:
  rules:
  - host: api.ringer.tel
    http:
      paths:
      - path: /v1/customers
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/trunks
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/partitions
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/providers
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/routing
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/messaging
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/cdrs
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/billing
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
      - path: /v1/metrics
        pathType: Exact
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
---
# SIP trunk endpoints with IP restriction
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: warp-api-sip
  namespace: kong
  annotations:
    kubernetes.io/ingress.class: kong
    konghq.com/plugins: |
      jwt-auth,
      api-key-auth,
      ip-restriction-sip,
      cors,
      global-rate-limit,
      prometheus,
      request-validator,
      response-transformer,
      acl
    konghq.com/override: warp-api-kongingress
spec:
  rules:
  - host: api.ringer.tel
    http:
      paths:
      - path: /v1/customers/*/trunks/*/ips
        pathType: Prefix
        backend:
          service:
            name: warp-api-kong
            port:
              number: 8080
---
# Per-customer rate limiting
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: customer-rate-limit
  namespace: kong
config:
  minute: 100
  hour: 5000
  day: 100000
  policy: local
  limit_by: consumer
  hide_client_headers: false
plugin: rate-limiting
---
# Apply customer rate limiting to specific consumers
apiVersion: configuration.konghq.com/v1
kind: KongConsumer
metadata:
  name: premium-customer
  namespace: kong
  annotations:
    konghq.com/plugins: customer-rate-limit
username: premium-customer
custom_id: "customer-uuid-here"
---
# API Key credential for the consumer
apiVersion: configuration.konghq.com/v1
kind: KongCredential
metadata:
  name: premium-customer-apikey
  namespace: kong
consumerRef: premium-customer
type: key-auth
config:
  key: "generated-api-key-here"
---
# JWT credential for the consumer
apiVersion: configuration.konghq.com/v1
kind: KongCredential
metadata:
  name: premium-customer-jwt
  namespace: kong
consumerRef: premium-customer
type: jwt
config:
  key: "jwt-issuer-key"
  secret: "jwt-secret-here"
  algorithm: "HS256"